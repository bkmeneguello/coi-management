SET FILES WRITE DELAY FALSE;

CREATE TABLE CATEGORIA (
	ID BIGINT GENERATED BY DEFAULT AS IDENTITY(START WITH 1),
	DESCRICAO VARCHAR(200),
	CONSTRAINT CATEGORIA_PK PRIMARY KEY (ID),
	CONSTRAINT CATEGORIA_DESCRICAO_UK UNIQUE (DESCRICAO)
);

CREATE TABLE PRODUTO (
	ID BIGINT GENERATED BY DEFAULT AS IDENTITY(START WITH 1),
	CODIGO VARCHAR(30),
	DESCRICAO VARCHAR(200),
	CUSTO DECIMAL(8,2) NOT NULL,
	PRECO DECIMAL(8,2) NOT NULL,
	CATEGORIA_ID BIGINT NOT NULL,
	ESTOCAVEL CHAR(1) NOT NULL,
	CONSTRAINT PRODUTO_PK PRIMARY KEY (ID),
	CONSTRAINT PRODUTO_FK_CATEGORIA FOREIGN KEY (CATEGORIA_ID) REFERENCES CATEGORIA(ID),
	CONSTRAINT PRODUTO_CODIGO_UK UNIQUE (CODIGO),
	CONSTRAINT PRODUTO_DESCRICAO_UK UNIQUE (DESCRICAO),
	CONSTRAINT PRODUTO_CHK_ESTOCAVEL CHECK (ESTOCAVEL IN('S', 'N'))
);

CREATE TABLE COMISSAO (
	ID BIGINT GENERATED BY DEFAULT AS IDENTITY(START WITH 1),
	PORCENTAGEM DECIMAL(5,2),
	CATEGORIA_ID BIGINT NOT NULL,
	PARTE VARCHAR(17) NOT NULL,
	CONSTRAINT COMISSAO_PK PRIMARY KEY (ID),
	CONSTRAINT COMISSAO_FK_CATEGORIA FOREIGN KEY (CATEGORIA_ID) REFERENCES CATEGORIA(ID),
	CONSTRAINT COMISSAO_PARTE_UK UNIQUE (CATEGORIA_ID, PARTE)
);

CREATE TABLE PESSOA (
	ID BIGINT GENERATED BY DEFAULT AS IDENTITY(START WITH 1),
	NOME VARCHAR(200) NOT NULL,
	PREFIXO CHAR(1) NOT NULL,
	CODIGO INTEGER NOT NULL,
	SEXO VARCHAR(9),
	DATA_NASCIMENTO DATE,
	CONSTRAINT PESSOA_PK PRIMARY KEY (ID),
	CONSTRAINT PESSOA_PREFIXO_CODIGO_UK UNIQUE (PREFIXO, CODIGO),
	CONSTRAINT PESSOA_CHK_SEXO CHECK (SEXO IN ('FEMININO', 'MASCULINO', NULL))
);

CREATE TABLE CHEQUE (
	ID BIGINT GENERATED BY DEFAULT AS IDENTITY(START WITH 1),
	NUMERO VARCHAR(200) NOT NULL,
	CONTA VARCHAR(200) NOT NULL,
	AGENCIA VARCHAR(200) NOT NULL,
	BANCO VARCHAR(200) NOT NULL,
	DOCUMENTO VARCHAR(200) NOT NULL,
	VALOR DECIMAL(8,2) NOT NULL,
	DATA_DEPOSITO DATE,
	OBSERVACAO VARCHAR(500),
	CLIENTE_ID BIGINT NOT NULL,
	PACIENTE_ID BIGINT NOT NULL,
	CONSTRAINT CHEQUE_PK PRIMARY KEY (ID),
	CONSTRAINT CHEQUE_FK_CLIENTE FOREIGN KEY (CLIENTE_ID) REFERENCES PESSOA(ID),
	CONSTRAINT CHEQUE_FK_PACIENTE FOREIGN KEY (PACIENTE_ID) REFERENCES PESSOA(ID),
	CONSTRAINT CHEQUE_UK UNIQUE (NUMERO, CONTA, AGENCIA, BANCO)
);

CREATE TABLE ENTRADA (
	ID BIGINT GENERATED BY DEFAULT AS IDENTITY(START WITH 1),
	DATA DATE NOT NULL,
	MEIO_PAGAMENTO VARCHAR(100) NOT NULL,
	PACIENTE_ID BIGINT NOT NULL,
	CONSTRAINT ENTRADA_PK PRIMARY KEY (ID),
	CONSTRAINT ENTRADA_CHK_MEIO_PAGAMENTO CHECK (MEIO_PAGAMENTO IN ('DINHEIRO', 'CARTAO_CREDITO', 'CARTAO_CREDITO_2X', 'CARTAO_CREDITO_3X', 'CARTAO_DEBITO', 'CHEQUE')),
	CONSTRAINT ENTRADA_FK_PACIENTE FOREIGN KEY (PACIENTE_ID) REFERENCES PESSOA(ID)
);

-- Produtos vinculados à entrada
CREATE TABLE ENTRADA_PRODUTO (
	ENTRADA_ID BIGINT NOT NULL,
	PRODUTO_ID BIGINT NOT NULL,
	QUANTIDADE INTEGER DEFAULT 1 NOT NULL,
	VALOR DECIMAL(8,2) NOT NULL,
	DESCONTO DECIMAL(8,2) DEFAULT 0,
	CONSTRAINT ENTRADA_PRODUTO_PK PRIMARY KEY (ENTRADA_ID, PRODUTO_ID),
	CONSTRAINT ENTRADA_PRODUTO_FK_ENTRADA FOREIGN KEY (ENTRADA_ID) REFERENCES ENTRADA(ID),
	CONSTRAINT ENTRADA_PRODUTO_FK_PRODUTO FOREIGN KEY (PRODUTO_ID) REFERENCES PRODUTO(ID)
);

-- Partes associadas à entrada com seus respectivos papeis
CREATE TABLE ENTRADA_PARTE (
	ENTRADA_ID BIGINT NOT NULL,
	PESSOA_ID BIGINT NOT NULL,
	PARTE VARCHAR(17) NOT NULL,
	CONSTRAINT ENTRADA_PARTE_FK_ENTRADA FOREIGN KEY (ENTRADA_ID) REFERENCES ENTRADA(ID),
	CONSTRAINT ENTRADA_PARTE_FK_PESSOA FOREIGN KEY (PESSOA_ID) REFERENCES PESSOA(ID),
	CONSTRAINT ENTRADA_PARTE_PK PRIMARY KEY (ENTRADA_ID, PARTE, PESSOA_ID)
);

CREATE TABLE ENTRADA_CHEQUE (
	ENTRADA_ID BIGINT NOT NULL,
	CHEQUE_ID BIGINT NOT NULL,
	CONSTRAINT ENTRADA_CHEQUE_PK PRIMARY KEY (ENTRADA_ID, CHEQUE_ID),
	CONSTRAINT ENTRADA_CHEQUE_FK_ENTRADA FOREIGN KEY (ENTRADA_ID) REFERENCES ENTRADA(ID),
	CONSTRAINT ENTRADA_CHEQUE_FK_CHEQUE FOREIGN KEY (CHEQUE_ID) REFERENCES CHEQUE(ID)
);

CREATE TABLE LAUDO (
	ID BIGINT GENERATED BY DEFAULT AS IDENTITY(START WITH 1),
	PACIENTE_ID BIGINT NOT NULL,
	MEDICO_ID BIGINT NOT NULL,
	DATA DATE NOT NULL,
	STATUS_HORMONAL VARCHAR(20) NOT NULL,
	COLUNA_LOMBAR_L1 CHAR(1) DEFAULT 'S' NOT NULL,
	COLUNA_LOMBAR_L2 CHAR(1) DEFAULT 'S' NOT NULL,
	COLUNA_LOMBAR_L3 CHAR(1) DEFAULT 'S' NOT NULL,
	COLUNA_LOMBAR_L4 CHAR(1) DEFAULT 'S' NOT NULL,
	COLUNA_LOMBAR_DENSIDADE DECIMAL(4,3),
	COLUNA_LOMBAR_TSCORE DECIMAL(3,1),
	COLUNA_LOMBAR_ZSCORE DECIMAL(3,1),
	COLO_FEMUR_DENSIDADE DECIMAL(4,3),
	COLO_FEMUR_TSCORE DECIMAL(3,1),
	COLO_FEMUR_ZSCORE DECIMAL(3,1),
	FEMUR_TOTAL_DENSIDADE DECIMAL(4,3),
	FEMUR_TOTAL_TSCORE DECIMAL(3,1),
	FEMUR_TOTAL_ZSCORE DECIMAL(3,1),
	RADIO_TERCO_DENSIDADE DECIMAL(4,3),
	RADIO_TERCO_TSCORE DECIMAL(3,1),
	RADIO_TERCO_ZSCORE DECIMAL(3,1),
	CORPO_INTEIRO_DENSIDADE DECIMAL(4,3),
	CORPO_INTEIRO_ZSCORE DECIMAL(3,1),
	CONCLUSAO VARCHAR(21) NOT NULL,
	CONSTRAINT LAUDO_PK PRIMARY KEY (ID),
	CONSTRAINT LAUDO_FK_PACIENTE FOREIGN KEY (PACIENTE_ID) REFERENCES PESSOA(ID),
	CONSTRAINT LAUDO_FK_MEDICO FOREIGN KEY (MEDICO_ID) REFERENCES PESSOA(ID),
	CONSTRAINT LAUDO_CHK_STATUS_HORMONAL CHECK (STATUS_HORMONAL IN ('PRE_MENOPAUSAL', 'POS_MENOPAUSAL', 'TRANSICAO_MENOPAUSAL'))
);

CREATE TABLE LAUDO_OBSERVACAO (
	LAUDO_ID BIGINT NOT NULL,
	CODIGO INTEGER NOT NULL,
	DESCRICAO VARCHAR(500) NOT NULL,
	EXTRA VARCHAR(100),
	CONSTRAINT LAUDO_OBSERVACAO_FK_LAUDO FOREIGN KEY (LAUDO_ID) REFERENCES LAUDO(ID)
);

CREATE TABLE LAUDO_COMPARACAO (
	LAUDO_ID BIGINT NOT NULL,
	CODIGO INTEGER NOT NULL,
	DESCRICAO VARCHAR(500) NOT NULL,
	EXTRA VARCHAR(100),
	CONSTRAINT LAUDO_COMPARACAO_FK_LAUDO FOREIGN KEY (LAUDO_ID) REFERENCES LAUDO(ID)
);

CREATE TABLE MOVIMENTO (
	ID BIGINT GENERATED BY DEFAULT AS IDENTITY(START WITH 1),
	DATA DATE NOT NULL,
	TIPO VARCHAR(7) NOT NULL,
	CONSTRAINT MOVIMENTO_PK PRIMARY KEY (ID),
	CONSTRAINT MOVIMENTO_CHK_TIPO CHECK (TIPO IN ('ENTRADA', 'BAIXA'))
);

CREATE TABLE MOVIMENTO_PRODUTO (
	MOVIMENTO_ID BIGINT NOT NULL,
	PRODUTO_ID BIGINT NOT NULL,
	QUANTIDADE INTEGER DEFAULT 1 NOT NULL,
	CONSTRAINT MOVIMENTO_PRODUTO_FK_MOVIMENTO FOREIGN KEY (MOVIMENTO_ID) REFERENCES MOVIMENTO(ID),
	CONSTRAINT MOVIMENTO_PRODUTO_FK_PRODUTO FOREIGN KEY (PRODUTO_ID) REFERENCES PRODUTO(ID)
);

CREATE TABLE PAGAMENTO_CATEGORIA (
	ID BIGINT GENERATED BY DEFAULT AS IDENTITY(START WITH 1),
	DESCRICAO VARCHAR(100) NOT NULL,
	CONSTRAINT PAGAMENTO_CATEGORIA_PK PRIMARY KEY (ID)
);

CREATE TABLE PAGAMENTO (
	ID BIGINT GENERATED BY DEFAULT AS IDENTITY(START WITH 1),
	CATEGORIA_ID BIGINT NOT NULL,
	VENCIMENTO DATE NOT NULL,
	DESCRICAO VARCHAR(100) NOT NULL,
	VALOR DECIMAL(8,2) NOT NULL,
	SITUACAO VARCHAR(8) DEFAULT 'PENDENTE' NOT NULL,
	PAGAMENTO DATE,
	FORMA_PAGAMENTO VARCHAR(27),
	BANCO VARCHAR(50),
	AGENCIA VARCHAR(10),
	CONTA VARCHAR(10),
	CHEQUE VARCHAR(50),
	CONSTRAINT PAGAMENTO_PK PRIMARY KEY (ID),
	CONSTRAINT PAGAMENTO_FK_PAGAMENTO_CATEGORIA FOREIGN KEY (CATEGORIA_ID) REFERENCES PAGAMENTO_CATEGORIA(ID),
	CONSTRAINT PAGAMENTO_CHK_SITUACAO CHECK (SITUACAO IN ('PENDENTE', 'PAGO')),
	CONSTRAINT PAGAMENTO_CHK_FORMA_PAGAMENTO CHECK (FORMA_PAGAMENTO IN ('DINHEIRO', 'PARCELADO', 'CHEQUE', 'CREDITO', 'DEBITO', 'DEBITO_AUTOMATICO'))
);

-- new

ALTER TABLE PAGAMENTO ADD COLUMN TIPO VARCHAR(7);
UPDATE PAGAMENTO SET TIPO = 'SAIDA';
ALTER TABLE PAGAMENTO ALTER COLUMN TIPO SET NOT NULL;
ALTER TABLE PAGAMENTO ADD CONSTRAINT PAGAMENTO_CHK_TIPO CHECK (TIPO IN ('ENTRADA', 'SAIDA'));